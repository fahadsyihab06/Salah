<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gun.js Chat Elegan</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #121212;
      color: #eee;
    }
    .container {
      padding: 20px;
      padding-bottom: 100px;
    }
    .chatBox {
      max-height: 400px;
      overflow-y: auto;
      background: #1e1e1e;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 10px;
    }
    .message {
      background: #2b2b2b;
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 10px;
      display: flex;
      gap: 10px;
    }
    .avatar-badge {
      background: #00e676;
      color: #000;
      font-weight: bold;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    .msg-content {
      flex: 1;
    }
    .avatar {
      font-weight: bold;
      color: #00e676;
      margin-bottom: 3px;
    }
    .typing-status {
      font-style: italic;
      color: #aaa;
      margin-bottom: 10px;
      min-height: 18px;
    }
    input[type="text"], input[type="file"] {
      background: #2c2c2c;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px;
      font-size: 16px;
      width: 100%;
      margin-bottom: 10px;
    }
    .input-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .input-group input[type="text"] {
      flex: 1;
      margin: 0;
    }
    .icon-button {
      background: #00c853;
      border: none;
      padding: 10px 14px;
      border-radius: 6px;
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .icon-button:hover {
      background: #00e676;
    }
    .navbar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #1a1a1a;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      border-top: 1px solid #333;
    }
    .navbar button {
      background: none;
      color: white;
      font-size: 18px;
      border: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
    }
    .active {
      color: #00e676;
    }
    img.chat-image {
      max-width: 100%;
      border-radius: 6px;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Gun.js Real-Time Chat</h2>
  <input type="text" id="nameInput" placeholder="Nama kamu...">
  <div class="typing-status" id="typingStatus"></div>
  <div class="chatBox" id="chatBox"></div>
  
  <div class="input-group">
    <input type="text" id="chatMsg" placeholder="Tulis pesan...">
    <button class="icon-button" onclick="sendChat()">
      <i class="fas fa-paper-plane"></i>
    </button>
    <button class="icon-button" onclick="document.getElementById('chatImg').click()">
      <i class="fas fa-image"></i>
    </button>
    <input type="file" id="chatImg" accept="image/*" style="display:none">
  </div>
</div>

<div class="navbar">
  <button class="active">
    <i class="fas fa-comments"></i>
    <span>Chat</span>
  </button>
</div>

<script>
  const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
  const chatRef = gun.get('elegant-chat');
  const typingRef = gun.get('typing-status');

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
    }[m]));
  }

  const nameInput = document.getElementById('nameInput');
  nameInput.value = localStorage.getItem('chatName') || '';
  nameInput.addEventListener('input', () => {
    localStorage.setItem('chatName', nameInput.value);
  });

  const chatMsg = document.getElementById('chatMsg');
  const typingStatus = document.getElementById('typingStatus');

  chatMsg.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendChat();
    updateTypingStatus(true);
  });

  let typingTimeout;
  function updateTypingStatus(isTyping) {
    const name = nameInput.value.trim();
    if (!name) return;
    typingRef.get(name).put(isTyping ? 1 : 0);
    clearTimeout(typingTimeout);
    if (isTyping) {
      typingTimeout = setTimeout(() => typingRef.get(name).put(0), 3000);
    }
  }

  let lastSent = 0;

  function sendChat() {
    const name = nameInput.value.trim();
    const msg = chatMsg.value.trim();
    const file = document.getElementById('chatImg').files[0];

    if (!name || (!msg && !file)) {
      alert("Isi nama dan pesan atau gambar");
      return;
    }

    const now = Date.now();
    if (now - lastSent < 1000) {
      alert("Tunggu sebentar sebelum mengirim pesan lagi.");
      return;
    }
    lastSent = now;

    if (file) {
      if (file.size > 1024 * 1024) {
        alert("Ukuran gambar maksimal 1MB");
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        chatRef.set({ name, msg, img: e.target.result, time: now });
      };
      reader.readAsDataURL(file);
    } else {
      chatRef.set({ name, msg, img: null, time: now });
    }

    chatMsg.value = '';
    document.getElementById('chatImg').value = '';
    updateTypingStatus(false);
  }

  const messages = [];
  const seenIds = new Set();
  const box = document.getElementById('chatBox');

  chatRef.map().on((data, id) => {
    if (!data || (!data.msg && !data.img) || seenIds.has(id)) return;
    seenIds.add(id);
    messages.push({ ...data, id });
    messages.sort((a, b) => a.time - b.time);
    box.innerHTML = '';
    messages.forEach(d => {
      const timeStr = d.time ? new Date(d.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
      const div = document.createElement('div');
      div.className = 'message';
      const avatarChar = escapeHtml((d.name || '?')[0].toUpperCase());
      div.innerHTML = `
        <div class="avatar-badge">${avatarChar}</div>
        <div class="msg-content">
          <div class="avatar">@${escapeHtml(d.name)} <small style="color:#aaa;font-size:12px;">${timeStr}</small></div>
          ${escapeHtml(d.msg || '')}
        </div>
      `;
      if (d.img) {
        const img = document.createElement('img');
        img.src = d.img;
        img.className = 'chat-image';
        div.querySelector('.msg-content').appendChild(img);
      }
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  });

  typingRef.map().on((isTyping, who) => {
    const me = nameInput.value.trim();
    if (isTyping && who !== me) {
      typingStatus.innerText = `${who} sedang mengetik...`;
    } else if (typingStatus.innerText.startsWith(who)) {
      typingStatus.innerText = '';
    }
  });
</script>

</body>
</html>
